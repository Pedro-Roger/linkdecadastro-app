<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inscreva-se no Curso - Link de Cadastro</title>
  <meta name="description" content="Formulário de inscrição em cursos - Link de Cadastro" />
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="" id="og-url" />
  <meta property="og:title" content="Inscreva-se no Curso - Link de Cadastro" id="og-title" />
  <meta property="og:description" content="Formulário de inscrição em cursos - Link de Cadastro" id="og-description" />
  <meta property="og:image" content="" id="og-image" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:site_name" content="Link de Cadastro" />
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="" id="twitter-url" />
  <meta name="twitter:title" content="Inscreva-se no Curso - Link de Cadastro" id="twitter-title" />
  <meta name="twitter:description" content="Formulário de inscrição em cursos - Link de Cadastro" id="twitter-description" />
  <meta name="twitter:image" content="" id="twitter-image" />
  
  <link rel="icon" type="image/png" href="/logo.png" />
  
  <!-- Script inline para atualizar meta tags IMEDIATAMENTE para crawlers (WhatsApp, Facebook, etc) -->
  <script>
    (function() {
      // Executa imediatamente, antes do DOMContentLoaded
      const urlParams = new URLSearchParams(window.location.search);
      const courseSlug = urlParams.get('course');
      
      if (courseSlug) {
        // Busca o curso da API imediatamente
        const API_URL = (() => {
          if (window.APP_CONFIG?.API_URL) return window.APP_CONFIG.API_URL;
          return 'https://backend-linkdecadastro.onrender.com';
        })();
        
        // Faz requisição síncrona para atualizar meta tags antes do crawler
        fetch(`${API_URL}/courses`)
          .then(response => response.json())
          .then(courses => {
            const course = courses.find(c => c.slug === courseSlug || c.id === courseSlug);
            if (course) {
              const baseUrl = window.location.origin;
              const shareUrl = `${baseUrl}/enroll.html?course=${course.slug || course.id}`;
              
              let imageUrl = course.bannerUrl;
              if (imageUrl) {
                if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
                  imageUrl = imageUrl;
                } else if (imageUrl.startsWith('/')) {
                  imageUrl = `${API_URL}${imageUrl}`;
                } else {
                  imageUrl = `${API_URL}/${imageUrl}`;
                }
              } else {
                imageUrl = `${baseUrl}/logo.png`;
              }
              
              // Atualiza meta tags
              const ogUrl = document.querySelector('meta[property="og:url"]');
              const ogTitle = document.querySelector('meta[property="og:title"]');
              const ogDescription = document.querySelector('meta[property="og:description"]');
              const ogImage = document.querySelector('meta[property="og:image"]');
              const twitterUrl = document.querySelector('meta[name="twitter:url"]');
              const twitterTitle = document.querySelector('meta[name="twitter:title"]');
              const twitterDescription = document.querySelector('meta[name="twitter:description"]');
              const twitterImage = document.querySelector('meta[name="twitter:image"]');
              
              if (ogUrl) ogUrl.setAttribute('content', shareUrl);
              if (ogTitle) ogTitle.setAttribute('content', `${course.title} - Link de Cadastro`);
              if (ogDescription) ogDescription.setAttribute('content', course.description || 'Inscreva-se neste curso no Link de Cadastro');
              if (ogImage) ogImage.setAttribute('content', imageUrl);
              
              if (twitterUrl) twitterUrl.setAttribute('content', shareUrl);
              if (twitterTitle) twitterTitle.setAttribute('content', `${course.title} - Link de Cadastro`);
              if (twitterDescription) twitterDescription.setAttribute('content', course.description || 'Inscreva-se neste curso no Link de Cadastro');
              if (twitterImage) twitterImage.setAttribute('content', imageUrl);
              
              document.title = `${course.title} - Link de Cadastro`;
            }
          })
          .catch(error => {
            console.error('Erro ao buscar curso para meta tags:', error);
          });
      }
    })();
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #003366 0%, #FF6600 100%);
      min-height: 100vh;
      padding: 2rem 1rem;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #003366 0%, #FF6600 100%);
      color: white;
      padding: 2rem;
      text-align: center;
      position: relative;
    }
    
    .back-button {
      position: absolute;
      top: 1rem;
      left: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      color: white;
      text-decoration: none;
      transition: background 0.3s, transform 0.2s;
      z-index: 10;
    }
    
    .back-button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    
    .back-button svg {
      width: 24px;
      height: 24px;
    }
    
    .header img {
      max-width: 150px;
      margin-bottom: 1rem;
    }
    
    .header h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 1rem;
    }
    
    .content {
      padding: 2rem;
    }
    
    .course-selector {
      margin-bottom: 2rem;
    }
    
    .course-selector label {
      display: block;
      font-weight: 600;
      color: #003366;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }
    
    .course-selector select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      cursor: pointer;
      transition: border-color 0.3s;
    }
    
    .course-selector select:focus {
      outline: none;
      border-color: #FF6600;
    }
    
    .course-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      overflow: hidden;
      margin-bottom: 2rem;
      display: none;
    }
    
    .course-card.active {
      display: block;
    }
    
    .course-card-banner {
      width: 100%;
      height: 250px;
      object-fit: cover;
      background: linear-gradient(135deg, #003366 0%, #FF6600 100%);
    }
    
    .course-card-content {
      padding: 1.5rem;
    }
    
    .course-card-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #003366;
      margin-bottom: 0.75rem;
    }
    
    .course-card-description {
      color: #666;
      line-height: 1.6;
      margin-bottom: 1rem;
    }
    
    .course-info {
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      display: none;
    }
    
    .course-info.active {
      display: block;
    }
    
    .course-info img {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #FF6600;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .error {
      color: #d32f2f;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: none;
    }
    
    .error.show {
      display: block;
    }
    
    .success {
      background: #4caf50;
      color: white;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: none;
    }
    
    .success.show {
      display: block;
    }
    
    .success-actions {
      margin-top: 1rem;
      display: flex;
      justify-content: center;
    }
    
    .success-actions a {
      background: #003366;
      color: white;
      padding: 0.85rem 1.5rem;
      border-radius: 999px;
      font-weight: 600;
      text-decoration: none;
      transition: background 0.3s;
    }
    
    .success-actions a:hover {
      background: #00264d;
    }
    
    .button {
      width: 100%;
      padding: 1rem;
      background: #FF6600;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .button:hover {
      background: #e55a00;
    }
    
    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #FF6600;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 640px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="/" class="back-button" title="Voltar para a página inicial">
        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </a>
      <img src="/logo B.png" alt="Link de Cadastro" />
      <h1>Formulário de Inscrição</h1>
      <p>Preencha os dados abaixo para se inscrever no curso</p>
    </div>
    
    <div class="content">
      <div class="success" id="success-message"></div>
      
      <!-- Card do Curso (exibido quando vem ?course=slug na URL) -->
      <div class="course-card" id="course-card">
        <img id="course-card-banner" class="course-card-banner" src="" alt="" />
        <div class="course-card-content">
          <h2 class="course-card-title" id="course-card-title"></h2>
          <p class="course-card-description" id="course-card-description"></p>
        </div>
      </div>
      
      <form id="enrollment-form">
        <div class="form-group course-selector">
          <label for="course">Selecione o Curso *</label>
          <select id="course" name="course" required>
            <option value="">Carregando cursos...</option>
          </select>
          <div class="course-info" id="course-info">
            <img id="course-banner" src="" alt="" />
            <p id="course-description"></p>
          </div>
        </div>
        
        <div class="form-group">
          <label for="name">Nome Completo *</label>
          <input type="text" id="name" name="name" required />
          <div class="error" id="name-error"></div>
        </div>
        
        <div class="form-group">
          <label for="email">E-mail *</label>
          <input type="email" id="email" name="email" required />
          <div class="error" id="email-error"></div>
        </div>
        
        <div class="form-group">
          <label for="cpf">CPF *</label>
          <input type="text" id="cpf" name="cpf" maxlength="14" placeholder="000.000.000-00" required />
          <div class="error" id="cpf-error"></div>
        </div>
        
        <div class="form-group">
          <label for="birthDate">Data de Nascimento *</label>
          <input type="date" id="birthDate" name="birthDate" max="" required />
          <div class="error" id="birthDate-error"></div>
        </div>
        
        <div class="form-group">
          <label for="whatsappNumber">WhatsApp (com DDD) *</label>
          <input type="tel" id="whatsappNumber" name="whatsappNumber" placeholder="(00) 00000-0000" required />
          <div class="error" id="whatsappNumber-error"></div>
        </div>
        
        <div class="form-group">
          <label for="participantType">Você é: *</label>
          <select id="participantType" name="participantType" required>
            <option value="">Selecione...</option>
            <option value="ESTUDANTE">Estudante</option>
            <option value="PROFESSOR">Professor</option>
            <option value="PESQUISADOR">Pesquisador</option>
            <option value="PRODUTOR">Produtor</option>
          </select>
          <div class="error" id="participantType-error"></div>
        </div>
        
        <div class="form-group" id="hectares-group" style="display: none;">
          <label for="hectares">Quantos hectares você possui? *</label>
          <input type="number" id="hectares" name="hectares" step="0.01" min="0" placeholder="Ex: 10.5" />
          <div class="error" id="hectares-error"></div>
        </div>
        
        <div class="form-group" id="waterArea-group" style="display: none;">
          <label for="waterArea">Quantos hectares de lâmina d'água você possui? *</label>
          <input type="number" id="waterArea" name="waterArea" step="0.01" min="0" placeholder="Ex: 8.5" />
          <div class="error" id="waterArea-error"></div>
        </div>
        
        <div class="form-group" id="ponds-group" style="display: none;">
          <label for="ponds">Quantos viveiros você possui? *</label>
          <input type="number" id="ponds" name="ponds" step="1" min="1" placeholder="Ex: 5" />
          <div class="error" id="ponds-error"></div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="state">Estado *</label>
            <select id="state" name="state" required>
              <option value="">Carregando...</option>
            </select>
            <div class="error" id="state-error"></div>
          </div>
          
          <div class="form-group">
            <label for="city">Cidade *</label>
            <select id="city" name="city" required disabled>
              <option value="">Selecione o estado primeiro</option>
            </select>
            <div class="error" id="city-error"></div>
          </div>
        </div>
        
        <button type="submit" class="button" id="submit-btn">Confirmar Inscrição</button>
      </form>
    </div>
  </div>
  
  <script>
    // Configuração da API
    const API_URL = (() => {
      if (window.APP_CONFIG?.API_URL) return window.APP_CONFIG.API_URL;
      return 'https://backend-linkdecadastro.onrender.com';
    })();
    
    // Estado da aplicação
    let courses = [];
    let states = [];
    let cities = [];
    
    // Inicialização
    document.addEventListener('DOMContentLoaded', async () => {
      // Configura data máxima (hoje)
      document.getElementById('birthDate').max = new Date().toISOString().split('T')[0];
      
      // Carrega cursos e estados
      await Promise.all([
        loadCourses(),
        loadStates()
      ]);
      
      // Verifica se há curso na URL e atualiza meta tags IMEDIATAMENTE
      const urlParams = new URLSearchParams(window.location.search);
      const courseSlug = urlParams.get('course');
      if (courseSlug && courses.length > 0) {
        const course = courses.find(c => c.slug === courseSlug || c.id === courseSlug);
        if (course) {
          document.getElementById('course').value = course.id;
          // Esconde o seletor de curso e mostra o card
          document.querySelector('.course-selector').style.display = 'none';
          showCourseCard(course);
          // Atualiza meta tags IMEDIATAMENTE para crawlers
          updateMetaTags(course);
        }
      }
      
      // Event listeners
      document.getElementById('course').addEventListener('change', (e) => {
        const course = courses.find(c => c.id === e.target.value);
        if (course) {
          updateCourseInfo(course);
          updateMetaTags(course);
        }
      });
      
      document.getElementById('participantType').addEventListener('change', (e) => {
        const hectaresGroup = document.getElementById('hectares-group');
        const waterAreaGroup = document.getElementById('waterArea-group');
        const pondsGroup = document.getElementById('ponds-group');
        
        if (e.target.value === 'PRODUTOR') {
          hectaresGroup.style.display = 'block';
          waterAreaGroup.style.display = 'block';
          pondsGroup.style.display = 'block';
          
          document.getElementById('hectares').required = true;
          document.getElementById('waterArea').required = true;
          document.getElementById('ponds').required = true;
        } else {
          hectaresGroup.style.display = 'none';
          waterAreaGroup.style.display = 'none';
          pondsGroup.style.display = 'none';
          
          document.getElementById('hectares').required = false;
          document.getElementById('waterArea').required = false;
          document.getElementById('ponds').required = false;
        }
      });
      
      document.getElementById('state').addEventListener('change', (e) => {
        if (e.target.value) {
          loadCities(e.target.value);
        } else {
          document.getElementById('city').innerHTML = '<option value="">Selecione o estado primeiro</option>';
          document.getElementById('city').disabled = true;
        }
      });
      
      // Formatação de campos
      document.getElementById('cpf').addEventListener('input', formatCPF);
      document.getElementById('whatsappNumber').addEventListener('input', formatWhatsApp);
      
      // Submit do formulário
      document.getElementById('enrollment-form').addEventListener('submit', handleSubmit);
    });
    
    // Carrega cursos
    async function loadCourses() {
      try {
        const response = await fetch(`${API_URL}/courses`);
        if (!response.ok) throw new Error('Erro ao carregar cursos');
        courses = await response.json();
        
        const select = document.getElementById('course');
        select.innerHTML = '<option value="">Selecione um curso...</option>';
        courses.forEach(course => {
          if (course.slug) {
            const option = document.createElement('option');
            option.value = course.id;
            option.textContent = course.title;
            select.appendChild(option);
          }
        });
      } catch (error) {
        console.error('Erro ao carregar cursos:', error);
        document.getElementById('course').innerHTML = '<option value="">Erro ao carregar cursos</option>';
      }
    }
    
    // Carrega estados
    async function loadStates() {
      try {
        const response = await fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome');
        if (!response.ok) throw new Error('Erro ao carregar estados');
        states = await response.json();
        
        const select = document.getElementById('state');
        select.innerHTML = '<option value="">Selecione o estado...</option>';
        states.forEach(state => {
          const option = document.createElement('option');
          option.value = state.sigla;
          option.textContent = state.nome;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao carregar estados:', error);
      }
    }
    
    // Carrega cidades
    async function loadCities(stateSigla) {
      const citySelect = document.getElementById('city');
      citySelect.disabled = true;
      citySelect.innerHTML = '<option value="">Carregando cidades...</option>';
      
      try {
        const response = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${stateSigla}/municipios`);
        if (!response.ok) throw new Error('Erro ao carregar cidades');
        cities = await response.json();
        cities.sort((a, b) => a.nome.localeCompare(b.nome));
        
        citySelect.innerHTML = '<option value="">Selecione a cidade...</option>';
        cities.forEach(city => {
          const option = document.createElement('option');
          option.value = city.nome;
          option.textContent = city.nome;
          citySelect.appendChild(option);
        });
        citySelect.disabled = false;
      } catch (error) {
        console.error('Erro ao carregar cidades:', error);
        citySelect.innerHTML = '<option value="">Erro ao carregar cidades</option>';
      }
    }
    
    // Mostra o card do curso (quando vem da URL)
    function showCourseCard(course) {
      const card = document.getElementById('course-card');
      const bannerImg = document.getElementById('course-card-banner');
      const titleEl = document.getElementById('course-card-title');
      const descriptionEl = document.getElementById('course-card-description');
      
      if (course.bannerUrl) {
        const bannerUrl = course.bannerUrl.startsWith('http') 
          ? course.bannerUrl 
          : `${API_URL}${course.bannerUrl}`;
        bannerImg.src = bannerUrl;
        bannerImg.onerror = function() {
          this.style.display = 'none';
        };
      } else {
        bannerImg.style.display = 'none';
      }
      
      titleEl.textContent = course.title || 'Curso';
      descriptionEl.textContent = course.description || 'Sem descrição disponível.';
      card.classList.add('active');
    }
    
    // Atualiza informações do curso (quando selecionado no dropdown)
    function updateCourseInfo(course) {
      const infoDiv = document.getElementById('course-info');
      const bannerImg = document.getElementById('course-banner');
      const descriptionP = document.getElementById('course-description');
      
      if (course.bannerUrl) {
        bannerImg.src = course.bannerUrl.startsWith('http') ? course.bannerUrl : `${API_URL}${course.bannerUrl}`;
        bannerImg.style.display = 'block';
      } else {
        bannerImg.style.display = 'none';
      }
      
      descriptionP.textContent = course.description || 'Sem descrição disponível.';
      infoDiv.classList.add('active');
    }
    
    // Atualiza meta tags para compartilhamento
    function updateMetaTags(course) {
      const baseUrl = window.location.origin;
      const shareUrl = `${baseUrl}/enroll.html?course=${course.slug || course.id}`;
      
      // Garante que a URL da imagem seja absoluta e acessível
      let imageUrl = course.bannerUrl;
      if (imageUrl) {
        if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
          // Já é uma URL absoluta
          imageUrl = imageUrl;
        } else if (imageUrl.startsWith('/')) {
          // URL relativa ao backend
          imageUrl = `${API_URL}${imageUrl}`;
        } else {
          // URL relativa sem barra inicial
          imageUrl = `${API_URL}/${imageUrl}`;
        }
      } else {
        imageUrl = `${baseUrl}/logo.png`;
      }
      
      // Atualiza as meta tags
      const ogUrl = document.getElementById('og-url');
      const ogTitle = document.getElementById('og-title');
      const ogDescription = document.getElementById('og-description');
      const ogImage = document.getElementById('og-image');
      const twitterUrl = document.getElementById('twitter-url');
      const twitterTitle = document.getElementById('twitter-title');
      const twitterDescription = document.getElementById('twitter-description');
      const twitterImage = document.getElementById('twitter-image');
      
      if (ogUrl) ogUrl.setAttribute('content', shareUrl);
      if (ogTitle) ogTitle.setAttribute('content', `${course.title} - Link de Cadastro`);
      if (ogDescription) ogDescription.setAttribute('content', course.description || 'Inscreva-se neste curso no Link de Cadastro');
      if (ogImage) ogImage.setAttribute('content', imageUrl);
      
      if (twitterUrl) twitterUrl.setAttribute('content', shareUrl);
      if (twitterTitle) twitterTitle.setAttribute('content', `${course.title} - Link de Cadastro`);
      if (twitterDescription) twitterDescription.setAttribute('content', course.description || 'Inscreva-se neste curso no Link de Cadastro');
      if (twitterImage) twitterImage.setAttribute('content', imageUrl);
      
      document.title = `${course.title} - Link de Cadastro`;
      
      // Força atualização das meta tags para crawlers
      // Adiciona um link rel="image_src" para garantir compatibilidade
      let imageLink = document.querySelector('link[rel="image_src"]');
      if (!imageLink) {
        imageLink = document.createElement('link');
        imageLink.rel = 'image_src';
        document.head.appendChild(imageLink);
      }
      imageLink.href = imageUrl;
    }
    
    // Formatação
    function formatCPF(e) {
      let value = e.target.value.replace(/\D/g, '').slice(0, 11);
      value = value.replace(/(\d{3})(\d)/, '$1.$2');
      value = value.replace(/(\d{3})(\d)/, '$1.$2');
      value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      e.target.value = value;
    }
    
    function formatWhatsApp(e) {
      let value = e.target.value.replace(/\D/g, '').slice(0, 11);
      if (value.length <= 2) {
        e.target.value = value;
      } else if (value.length <= 6) {
        e.target.value = `(${value.slice(0, 2)}) ${value.slice(2)}`;
      } else if (value.length <= 10) {
        e.target.value = `(${value.slice(0, 2)}) ${value.slice(2, 6)}-${value.slice(6)}`;
      } else {
        e.target.value = `(${value.slice(0, 2)}) ${value.slice(2, 7)}-${value.slice(7)}`;
      }
    }
    
    // Validação
    function validateForm(formData) {
      const errors = {};
      
      if (!formData.course) errors.course = 'Selecione um curso';
      if (!formData.name || formData.name.trim().length < 3) errors.name = 'Nome deve ter pelo menos 3 caracteres';
      if (!formData.email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) errors.email = 'Email inválido';
      
      const cpfDigits = formData.cpf.replace(/\D/g, '');
      if (cpfDigits.length !== 11) errors.cpf = 'CPF deve ter 11 dígitos';
      
      if (!formData.birthDate) errors.birthDate = 'Data de nascimento é obrigatória';
      
      const whatsappDigits = formData.whatsappNumber.replace(/\D/g, '');
      if (whatsappDigits.length < 10 || whatsappDigits.length > 11) errors.whatsappNumber = 'WhatsApp inválido';
      
      if (!formData.participantType) errors.participantType = 'Selecione o tipo de participante';
      if (formData.participantType === 'PRODUTOR') {
        if (!formData.hectares || parseFloat(formData.hectares) <= 0) {
          errors.hectares = 'Hectares é obrigatório para produtores';
        }
        if (!formData.waterArea || parseFloat(formData.waterArea) <= 0) {
          errors.waterArea = 'Hectares de lâmina d\'água é obrigatório';
        }
        if (!formData.ponds || parseInt(formData.ponds) <= 0) {
          errors.ponds = 'Quantidade de viveiros é obrigatória';
        }
      }
      if (!formData.state) errors.state = 'Selecione o estado';
      if (!formData.city) errors.city = 'Selecione a cidade';
      
      return errors;
    }
    
    // Submit
    async function handleSubmit(e) {
      e.preventDefault();
      
      const formData = {
        course: document.getElementById('course').value,
        name: document.getElementById('name').value.trim(),
        email: document.getElementById('email').value.trim(),
        cpf: document.getElementById('cpf').value,
        birthDate: document.getElementById('birthDate').value,
        whatsappNumber: document.getElementById('whatsappNumber').value,
        participantType: document.getElementById('participantType').value,
        participantType: document.getElementById('participantType').value,
        hectares: document.getElementById('hectares').value,
        waterArea: document.getElementById('waterArea').value,
        ponds: document.getElementById('ponds').value,
        state: document.getElementById('state').value,
        state: document.getElementById('state').value,
        city: document.getElementById('city').value
      };
      
      // Limpa erros anteriores
      document.querySelectorAll('.error').forEach(el => {
        el.classList.remove('show');
        el.textContent = '';
      });
      
      // Valida
      const errors = validateForm(formData);
      if (Object.keys(errors).length > 0) {
        Object.keys(errors).forEach(key => {
          const errorEl = document.getElementById(`${key}-error`);
          if (errorEl) {
            errorEl.textContent = errors[key];
            errorEl.classList.add('show');
          }
        });
        return;
      }
      
      // Desabilita botão
      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Enviando...';
      
      try {
        // Prepara dados
        const cpf = formData.cpf.replace(/\D/g, '');
        const whatsapp = formData.whatsappNumber.replace(/\D/g, '');
        const hectares = formData.participantType === 'PRODUTOR' ? parseFloat(formData.hectares) : undefined;
        
        // Verifica se o curso foi selecionado
        if (!formData.course) {
          throw new Error('Por favor, selecione um curso');
        }
        
        // Log para debug (remover em produção)
        console.log('Enviando inscrição:', {
          courseId: formData.course,
          email: formData.email,
          name: formData.name
        });
        
        // Envia para o backend
        const response = await fetch(`${API_URL}/courses/${formData.course}/enroll-by-email`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: formData.email,
            name: formData.name,
            cpf: cpf,
            birthDate: formData.birthDate,
            participantType: formData.participantType,
            hectares: hectares,
            state: formData.state,
            city: formData.city,
            whatsappNumber: whatsapp
          })
        });
        
        const result = await response.json();
        
        // Log da resposta (remover em produção)
        console.log('Resposta do servidor:', result);
        
        if (!response.ok) {
          const errorMessage = result.error || result.message || 'Erro ao processar inscrição';
          console.error('Erro do servidor:', errorMessage);
          throw new Error(errorMessage);
        }
        
        // Verifica se a inscrição foi criada
        if (!result.enrollment) {
          console.error('Resposta sem enrollment:', result);
          throw new Error('Inscrição não foi criada. Verifique os logs do servidor.');
        }
        
        // Sucesso
        document.getElementById('enrollment-form').style.display = 'none';
        const successMsg = document.getElementById('success-message');
        successMsg.innerHTML = `
          Inscrição realizada com sucesso! Você receberá um email de confirmação em breve.
          <div class="success-actions">
            <a href="/">Voltar para página inicial</a>
          </div>
        `;
        successMsg.classList.add('show');
        
      } catch (error) {
        console.error('Erro completo:', error);
        const errorMsg = document.getElementById('email-error');
        errorMsg.textContent = error.message || 'Erro ao processar inscrição. Tente novamente.';
        errorMsg.classList.add('show');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Confirmar Inscrição';
      }
    }
  </script>
  
  <!-- Configuração da API (pode ser editada no servidor) -->
  <script src="/config.js"></script>
</body>
</html>

