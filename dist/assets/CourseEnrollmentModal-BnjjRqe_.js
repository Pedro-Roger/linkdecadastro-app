import{u as ie,j as e}from"./index-DME__o-_.js";import{d as n}from"./react-vendor-40RSlyA9.js";import{o as ne,u as le,Z as R,s as f,e as ce}from"./form-vendor-UKDbifrO.js";import{t as de}from"./zod-Bd6eNPbn.js";import{a as v}from"./api-cc_Vofyw.js";const me=["ESTUDANTE","PROFESSOR","PESQUISADOR","PRODUTOR"],pe=ne({name:f().min(1,"Nome é obrigatório").optional(),email:f().email("Email inválido").optional(),password:f().min(6,"Senha deve ter no mínimo 6 caracteres").optional(),cpf:f().min(11,"CPF deve ter 11 dígitos"),birthDate:f().min(1,"Data de nascimento é obrigatória"),participantType:ce(me,{required_error:"Selecione o tipo de participante"}),hectares:f().optional(),state:f().min(2,"Estado é obrigatório"),city:f().min(1,"Cidade é obrigatória"),whatsappNumber:f().min(10,"Informe o WhatsApp com DDD")}),ue=(l,o=!1)=>pe.superRefine((u,b)=>{u.cpf.replace(/\D/g,"").length!==11&&b.addIssue({code:R.custom,message:"CPF deve ter 11 dígitos",path:["cpf"]});const c=u.whatsappNumber.replace(/\D/g,"");if((c.length<10||c.length>11)&&b.addIssue({code:R.custom,message:"Informe um número de WhatsApp válido (com DDD)",path:["whatsappNumber"]}),u.participantType==="PRODUTOR"){const d=parseFloat(u.hectares??"");(Number.isNaN(d)||d<=0)&&b.addIssue({code:R.custom,message:"Hectares é obrigatório para produtores e deve ser maior que zero",path:["hectares"]})}l&&(u.email||b.addIssue({code:R.custom,message:"Email é obrigatório",path:["email"]}),o||(u.name||b.addIssue({code:R.custom,message:"Nome é obrigatório",path:["name"]}),u.password||b.addIssue({code:R.custom,message:"Senha é obrigatória",path:["password"]})))}),X=[{sigla:"AC",nome:"Acre"},{sigla:"AL",nome:"Alagoas"},{sigla:"AP",nome:"Amapá"},{sigla:"AM",nome:"Amazonas"},{sigla:"BA",nome:"Bahia"},{sigla:"CE",nome:"Ceará"},{sigla:"DF",nome:"Distrito Federal"},{sigla:"ES",nome:"Espírito Santo"},{sigla:"GO",nome:"Goiás"},{sigla:"MA",nome:"Maranhão"},{sigla:"MT",nome:"Mato Grosso"},{sigla:"MS",nome:"Mato Grosso do Sul"},{sigla:"MG",nome:"Minas Gerais"},{sigla:"PA",nome:"Pará"},{sigla:"PB",nome:"Paraíba"},{sigla:"PR",nome:"Paraná"},{sigla:"PE",nome:"Pernambuco"},{sigla:"PI",nome:"Piauí"},{sigla:"RJ",nome:"Rio de Janeiro"},{sigla:"RN",nome:"Rio Grande do Norte"},{sigla:"RS",nome:"Rio Grande do Sul"},{sigla:"RO",nome:"Rondônia"},{sigla:"RR",nome:"Roraima"},{sigla:"SC",nome:"Santa Catarina"},{sigla:"SP",nome:"São Paulo"},{sigla:"SE",nome:"Sergipe"},{sigla:"TO",nome:"Tocantins"}];function ge(l){return l.replace(/\D/g,"").slice(0,11).replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2")}function he(l){const o=l.replace(/\D/g,"").slice(0,11);return o.length<=2?o:o.length<=6?`(${o.slice(0,2)}) ${o.slice(2)}`:o.length<=10?`(${o.slice(0,2)}) ${o.slice(2,6)}-${o.slice(6)}`:`(${o.slice(0,2)}) ${o.slice(2,7)}-${o.slice(7)}`}function je({isOpen:l,onClose:o,courseId:u,courseTitle:b,onSuccess:V}){const{user:c}=ie(),d=!c,[y,k]=n.useState(!1),[z,B]=n.useState(!1),[xe,P]=n.useState(null),[Y,J]=n.useState([]),[ee,C]=n.useState([]),[W,q]=n.useState(!1),[_,Q]=n.useState(!1),[Z,N]=n.useState(!1),[se,w]=n.useState(!1),[H,g]=n.useState(null),[E,T]=n.useState(null),te=n.useMemo(()=>ue(d,y),[d,y]),{register:m,handleSubmit:ae,watch:G,setValue:F,reset:j,formState:{errors:r}}=le({resolver:de(te),defaultValues:{name:"",email:"",state:"",city:"",whatsappNumber:""},shouldUnregister:!0}),S=G("state"),re=G("participantType"),I=G("email");n.useEffect(()=>{l&&c?(K(),T(null),g(null),(async()=>{try{const t=await v("/user/profile",{auth:!0}),i={};t.phone&&(i.whatsappNumber=t.phone),t.state&&(i.state=t.state,L(t.state)),t.city&&(i.city=t.city),t.participantType&&(i.participantType=t.participantType),t.hectares&&(i.hectares=String(t.hectares)),j(h=>({...h,...i}))}catch(t){console.error("Erro ao buscar perfil do usuário:",t);const i={whatsappNumber:c?.phone||""};c?.state&&(i.state=c.state,L(c.state)),c?.city&&(i.city=c.city),j(h=>({...h,...i}))}})()):l&&(K(),T(null),g(null),j(s=>({...s,whatsappNumber:""})))},[l,j,c]),n.useEffect(()=>{l&&S&&S.length===2?L(S):(C([]),S||F("city",""))},[l,S,F]),n.useEffect(()=>{if(!d||!I||!I.includes("@")){k(!1),P(null);return}const s=setTimeout(async()=>{B(!0);try{try{await v("/auth/register",{method:"POST",body:JSON.stringify({name:"test",email:I,password:"test123456"})}),k(!1),P(null)}catch(t){t?.message?.includes("já existe")||t?.message?.includes("already exists")||t?.message?.includes("já cadastrado")||t?.message?.includes("Email já cadastrado")?k(!0):(k(!1),P(null))}}catch{k(!1),P(null)}finally{B(!1)}},800);return()=>clearTimeout(s)},[I,d]);const K=async()=>{try{q(!0);const s=await fetch("https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome");if(s.ok){const t=await s.json();J(t)}else J(X)}catch{J(X)}finally{q(!1)}},L=async s=>{try{Q(!0);const t=await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${s}/municipios`);if(t.ok){const h=(await t.json()).sort((p,D)=>p.nome.localeCompare(D.nome));C(h)}else C([])}catch{C([])}finally{Q(!1)}},O=()=>{o(),j(),T(null),g(null)},oe=async s=>{N(!0),g(null),T(null);const t=s.cpf.replace(/\D/g,""),i=s.whatsappNumber.replace(/\D/g,""),h=s.participantType==="PRODUTOR"?parseFloat((s.hectares??"").replace(",",".")):void 0;try{if(d&&s.email){if(w(!0),y)if(s.password)try{const a=await v("/auth/login",{method:"POST",body:JSON.stringify({email:s.email,password:s.password})});typeof window<"u"&&(localStorage.setItem("token",a.accessToken),localStorage.setItem("user",JSON.stringify(a.user)))}catch(a){g(a?.message||"Senha incorreta. Se não lembrar sua senha, deixe em branco para vincular apenas com o email."),w(!1),N(!1);return}else try{const a=await v(`/courses/${u}/enroll-by-email`,{method:"POST",body:JSON.stringify({email:s.email,cpf:t,birthDate:s.birthDate,participantType:s.participantType,hectares:s.participantType==="PRODUTOR"?h:void 0,state:s.state,city:s.city,whatsappNumber:i})}),x=a.enrollment?.status,$=a.metadata?.waitlistPosition??null;let U="Inscrição realizada com sucesso! A inscrição foi vinculada à sua conta existente.";x==="WAITLIST"?U=$&&$>0?`Você entrou na lista de espera deste curso. Sua posição atual é ${$}.`:"Você entrou na lista de espera deste curso. Aguarde a aprovação do administrador.":x==="PENDING_REGION"?U=a.enrollment?.eligibilityReason||"Seu cadastro foi recebido, mas ainda não está elegível para participar deste curso.":x==="REJECTED"&&(U=a.enrollment?.eligibilityReason||"Sua inscrição foi registrada, mas não pôde ser aprovada."),T({status:x??"CONFIRMED",message:U,waitlistPosition:$}),j({name:"",email:"",password:"",cpf:"",birthDate:"",participantType:"ESTUDANTE",hectares:"",state:"",city:"",whatsappNumber:""}),V?.({enrollment:a.enrollment,metadata:a.metadata}),w(!1),N(!1);return}catch(a){g(a?.message||"Erro ao fazer inscrição. Verifique os dados informados."),w(!1),N(!1);return}else if(!y&&s.password&&s.name)try{const a=await v("/auth/register",{method:"POST",body:JSON.stringify({name:s.name,email:s.email,password:s.password,cpf:t,birthDate:s.birthDate,participantType:s.participantType,hectares:s.participantType==="PRODUTOR"?h:void 0,state:s.state,city:s.city,phone:i})});a.accessToken&&typeof window<"u"&&(localStorage.setItem("token",a.accessToken),localStorage.setItem("user",JSON.stringify(a.user)))}catch(a){if(a?.message?.includes("já existe")||a?.message?.includes("already exists")||a?.message?.includes("já cadastrado")||a?.message?.includes("Email já cadastrado"))try{const x=await v("/auth/login",{method:"POST",body:JSON.stringify({email:s.email,password:s.password})});typeof window<"u"&&(localStorage.setItem("token",x.accessToken),localStorage.setItem("user",JSON.stringify(x.user)))}catch(x){g(x?.message||"Erro ao fazer login. Verifique suas credenciais."),w(!1),N(!1);return}else{g(a?.message||"Erro ao criar conta"),w(!1),N(!1);return}}w(!1)}const p=await v(`/courses/${u}/enroll`,{method:"POST",auth:!0,body:JSON.stringify({cpf:t,birthDate:s.birthDate,participantType:s.participantType,hectares:s.participantType==="PRODUTOR"?h:void 0,state:s.state,city:s.city,whatsappNumber:i})}),D=p.enrollment?.status,A=p.metadata?.waitlistPosition??null;let M="Inscrição realizada com sucesso!";D==="WAITLIST"?M=A&&A>0?`Você entrou na lista de espera deste curso. Sua posição atual é ${A}.`:"Você entrou na lista de espera deste curso. Aguarde a aprovação do administrador.":D==="PENDING_REGION"?M=p.enrollment?.eligibilityReason||"Seu cadastro foi recebido, mas ainda não está elegível para participar deste curso.":D==="REJECTED"&&(M=p.enrollment?.eligibilityReason||"Sua inscrição foi registrada, mas não pôde ser aprovada."),T({status:D??"CONFIRMED",message:M,waitlistPosition:A}),j({name:"",email:"",password:"",cpf:"",birthDate:"",participantType:"ESTUDANTE",hectares:"",state:"",city:"",whatsappNumber:""}),V?.({enrollment:p.enrollment,metadata:p.metadata})}catch(p){g(p instanceof Error?p.message:"Erro ao processar inscrição"),w(!1)}finally{N(!1)}};return l?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4",children:e.jsxs("div",{className:"flex max-h-[90vh] w-full max-w-2xl flex-col overflow-hidden rounded-lg bg-white shadow-xl",children:[e.jsxs("div",{className:"sticky top-0 flex items-center justify-between border-b bg-white px-6 py-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-[#003366]",children:d?"Cadastrar e Inscrever-se":"Inscrever-se no Curso"}),e.jsx("button",{onClick:O,className:"text-gray-400 transition-colors hover:text-gray-600",type:"button",children:e.jsx("svg",{className:"h-6 w-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto px-6 py-6",children:[e.jsxs("p",{className:"mb-6 text-gray-600",children:["Curso:"," ",e.jsx("span",{className:"font-semibold text-[#003366]",children:b})]}),E&&e.jsx("div",{className:`mb-6 rounded-lg border px-4 py-3 text-sm ${E.status==="CONFIRMED"?"border-green-200 bg-green-50 text-green-800":E.status==="WAITLIST"?"border-yellow-200 bg-yellow-50 text-yellow-800":"border-blue-200 bg-blue-50 text-blue-800"}`,children:E.message}),H&&e.jsx("div",{className:"mb-6 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700",children:H}),!E&&e.jsxs("form",{onSubmit:ae(oe),className:"space-y-4",children:[d&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"E-mail *"}),e.jsx("input",{...m("email"),type:"email",placeholder:"seu@email.com",className:"w-full rounded-md border border-gray-300 px-4 py-2 text-gray-900 focus:border-transparent focus:ring-2 focus:ring-[#FF6600]"}),z&&e.jsx("p",{className:"mt-1 text-sm text-blue-500",children:"Verificando email..."}),y&&!z&&e.jsxs("div",{className:"mt-1",children:[e.jsx("p",{className:"text-sm text-green-600 font-medium",children:"✓ Email já cadastrado. A inscrição será vinculada à sua conta existente."}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Você pode deixar a senha em branco para vincular apenas pelo email."})]}),r.email&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.email.message})]}),!y&&e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Nome Completo *"}),e.jsx("input",{...m("name"),type:"text",placeholder:"Seu nome completo",className:"w-full rounded-md border border-gray-300 px-4 py-2 text-gray-900 focus:border-transparent focus:ring-2 focus:ring-[#FF6600]"}),r.name&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.name.message})]}),!y&&e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Senha *"}),e.jsx("input",{...m("password"),type:"password",placeholder:"Mínimo 6 caracteres",className:"w-full rounded-md border border-gray-300 px-4 py-2 text-gray-900 focus:border-transparent focus:ring-2 focus:ring-[#FF6600]"}),r.password&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.password.message})]}),y&&e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Senha (opcional)"}),e.jsx("input",{...m("password"),type:"password",placeholder:"Digite sua senha se quiser fazer login (opcional)",className:"w-full rounded-md border border-gray-300 px-4 py-2 text-gray-900 focus:border-transparent focus:ring-2 focus:ring-[#FF6600]"}),e.jsx("p",{className:"mt-1 text-xs text-green-600",children:"✓ Você pode deixar a senha em branco. A inscrição será vinculada automaticamente à sua conta pelo email."})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"CPF *"}),e.jsx("input",{...m("cpf"),type:"text",maxLength:14,inputMode:"numeric",placeholder:"000.000.000-00",className:"w-full rounded-md border border-gray-300 px-4 py-2 text-gray-900 focus:border-transparent focus:ring-2 focus:ring-[#FF6600]",onChange:s=>{const t=s.target.value.replace(/\D/g,"").slice(0,11);F("cpf",t,{shouldValidate:!0}),s.target.value=ge(t)}}),r.cpf&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.cpf.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Data de Nascimento *"}),e.jsx("input",{...m("birthDate"),type:"date",max:new Date().toISOString().split("T")[0],className:"w-full rounded-md border border-gray-300 px-4 py-2 text-gray-900 focus:border-transparent focus:ring-2 focus:ring-[#FF6600]"}),r.birthDate&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.birthDate.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"WhatsApp (com DDD) *"}),e.jsx("input",{...m("whatsappNumber"),type:"tel",inputMode:"tel",placeholder:"(00) 00000-0000",className:"w-full rounded-md border border-gray-300 px-4 py-2 text-gray-900 focus:border-transparent focus:ring-2 focus:ring-[#FF6600]",onChange:s=>{const t=s.target.value.replace(/\D/g,"").slice(0,11);F("whatsappNumber",t,{shouldValidate:!0}),s.target.value=he(t)}}),r.whatsappNumber&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.whatsappNumber.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700 md:text-base",children:"Você é: *"}),e.jsxs("select",{...m("participantType"),className:"w-full rounded-md border border-gray-300 px-4 py-3 text-base text-gray-900 focus:border-transparent focus:ring-2 focus:ring-[#FF6600] md:py-2 md:text-sm appearance-none bg-white cursor-pointer min-h-[48px] touch-manipulation",style:{backgroundImage:`url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e")`,backgroundPosition:"right 0.75rem center",backgroundRepeat:"no-repeat",backgroundSize:"1.5em 1.5em",paddingRight:"2.5rem"},children:[e.jsx("option",{value:"",children:"Selecione..."}),e.jsx("option",{value:"ESTUDANTE",children:"Estudante"}),e.jsx("option",{value:"PROFESSOR",children:"Professor"}),e.jsx("option",{value:"PESQUISADOR",children:"Pesquisador"}),e.jsx("option",{value:"PRODUTOR",children:"Produtor"})]}),r.participantType&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.participantType.message})]}),re==="PRODUTOR"&&e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Quantos hectares você possui? *"}),e.jsx("input",{...m("hectares"),type:"number",step:"0.01",min:"0",placeholder:"Ex: 10.5",className:"w-full rounded-md border border-gray-300 px-4 py-2 text-gray-900 focus:border-transparent focus:ring-2 focus:ring-[#FF6600]"}),r.hectares&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.hectares.message})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700 md:text-base",children:"Estado *"}),e.jsxs("select",{...m("state"),disabled:W,className:"w-full rounded-md border border-gray-300 px-4 py-3 text-base text-gray-900 focus:border-transparent focus:ring-2 focus:ring-[#FF6600] disabled:opacity-50 md:py-2 md:text-sm appearance-none bg-white cursor-pointer min-h-[48px] touch-manipulation",style:{backgroundImage:`url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e")`,backgroundPosition:"right 0.75rem center",backgroundRepeat:"no-repeat",backgroundSize:"1.5em 1.5em",paddingRight:"2.5rem"},children:[e.jsx("option",{value:"",children:W?"Carregando estados...":"Selecione o estado..."}),Y.map(s=>e.jsx("option",{value:s.sigla,children:s.nome},s.sigla))]}),r.state&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.state.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700 md:text-base",children:"Cidade *"}),e.jsxs("select",{...m("city"),disabled:!S||_,className:"w-full rounded-md border border-gray-300 px-4 py-3 text-base text-gray-900 focus:border-transparent focus:ring-2 focus:ring-[#FF6600] disabled:opacity-50 md:py-2 md:text-sm appearance-none bg-white cursor-pointer min-h-[48px] touch-manipulation",style:{backgroundImage:`url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e")`,backgroundPosition:"right 0.75rem center",backgroundRepeat:"no-repeat",backgroundSize:"1.5em 1.5em",paddingRight:"2.5rem"},children:[e.jsx("option",{value:"",children:_?"Carregando cidades...":S?"Selecione a cidade...":"Selecione o estado primeiro"}),ee.map(s=>e.jsx("option",{value:s.nome,children:s.nome},s.nome))]}),r.city&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.city.message})]})]}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx("button",{type:"button",onClick:O,className:"flex-1 rounded-md border border-gray-300 px-6 py-3 font-semibold text-gray-700 transition-colors hover:bg-gray-50",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:Z,className:"flex-1 rounded-md bg-[#FF6600] px-6 py-3 font-semibold text-white transition-colors hover:bg-[#e55a00] disabled:cursor-not-allowed disabled:opacity-50",children:Z?se?"Cadastrando...":"Enviando...":d?"Cadastrar e Inscrever-se":"Confirmar Inscrição"})]})]})]}),E&&e.jsx("div",{className:"border-t bg-gray-50 px-6 py-4",children:e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("span",{className:"text-sm text-gray-700",children:"Revise suas notificações para acompanhar o status da inscrição."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{type:"button",onClick:O,className:"rounded-md border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 transition-colors hover:bg-gray-100",children:"Fechar"}),e.jsx("button",{type:"button",onClick:O,className:"rounded-md bg-[#FF6600] px-4 py-2 text-sm font-semibold text-white transition-colors hover:bg-[#e55a00]",children:"Entendi"})]})]})})]})}):null}export{je as C};
